# inventory-history

## Описание

inventory-history - Тестовый сервис истории остатков товаров - 217.171.146.85:3002

inventory-history — это серверное приложение, написанное на Node.js (typescript), которое предоставляет API для работы с историей товаров и их распределением по магазинам. Оно работает с использованием СУБД PostgreSQL для хранения данных и включает в себя базовую структуру для взаимодействия с клиентами через REST API.

## Требования

- Node.js (версия 14 и выше)
- PostgreSQL (для хранения данных)

## Установка

### 1. Клонировать репозиторий

Склонируйте репозиторий с GitHub:

```bash
git clone https://github.com/yourusername/history.git
cd history
```

### 2. Установить зависимости

Установите все необходимые зависимости с помощью `npm`:

```bash
npm install
```

### 3. Настроить базу данных

Настройте PostgreSQL, создав базу данных и таблицы для хранения информации о товарах и их остатках.
В файле `.env` добавьте настройки подключения к базе данных:

```env
URL=localhost
PORT=3000
HISTORY_URL=localhost
HISTORY_PORT=3002
DB_NAME_MAIN = postgres
DB_USER=history
DB_HOST=localhost
DB_NAME=history
DB_PASSWORD=4321
DB_PORT=5432
```

### 4. Запуск сервера в режиме разработки

Для запуска сервера в режиме разработки с использованием `nodemon`, выполните:

```bash
npm run dev
```

### 5. Запуск сервера в продакшн-режиме

Для запуска сервера в продакшн-режиме выполните:

```bash
npm run start
```

## Структура проекта

- **src/app.ts** — основной файл сервера.
- **src/routes/** — роуты API для работы с остатками (`stocks`, `product`, `history`).
- **src/services/** — сервисы для работы с бизнес-логикой (например, добавление истории изменений остатков).
- **src/utils/** — утилиты для работы с базой данных, валидацией, ошибками и датами.
- **src/types/** — типы и интерфейсы для данных, использующихся в API.

## API

### 1. Добавление остатков

**POST /stocks**

Добавляет новый товар или обновляет существующий товар на складе.

**Тело запроса**:

```json
{
  "plu": "12345",
  "shop_id": "1",
  "action": "add_stocks",
  "quantity_on_shelf": 10,
  "quantity_in_order": 5
}
```

**Ответ**:

```json
{
  "plu": "12345",
  "shop_id": "1",
  "action": "add_stocks",
  "quantity_on_shelf": 10,
  "quantity_in_order": 5,
  "balance_on_shelf": 10,
  "balance_in_order": 0,
  "timestamp": "2024-12-08T12:34:56.789Z"
}
```

### 2. Увеличение остатков

**PUT /stocks/inc**

Увеличивает количество товара на складе.

**Тело запроса**:

```json
{
  "plu": "12345",
  "shop_id": "1",
  "action": "inc_stocks",
  "quantity_on_shelf": 5,
  "quantity_in_order": 3
}
```

**Ответ**:

```json
{
  "plu": "12345",
  "shop_id": "1",
  "action": "inc_stocks",
  "quantity_on_shelf": 5,
  "quantity_in_order": 3,
  "balance_on_shelf": 15,
  "balance_in_order": 0,
  "timestamp": "2024-12-08T12:34:56.789Z"
}
```

### 3. Уменьшение остатков

**PUT /stocks/dec**

Уменьшает количество товара на складе.

**Тело запроса**:

```json
{
  "plu": "12345",
  "shop_id": "1",
  "action": "dec_stocks",
  "quantity_on_shelf": 3,
  "quantity_in_order": 2
}
```

**Ответ**:

````json
{
  "plu": "12345",
  "shop_id": "1",
  "action": "dec_stocks",
  "quantity_on_shelf": 3,
  "quantity_in_order": 2,
  "balance_on_shelf": 12,
  "balance_in_order": 0,
  "timestamp": "2024-12-08T12:34:56.789Z"
}



### 4. Добавление товара

**POST /product**

Добавляет товар в номенклатуру товаров.

**Тело запроса**:

```json
{
  "plu": "12345",
  "action": "add"
}
````

**Ответ**:

```json
{
  "plu": "12345",
  "shop_id": 0,
  "action": "add",
  "quantity_on_shelf": 0,
  "quantity_in_order": 0,
  "balance_on_shelf": 0,
  "balance_in_order": 0,
  "timestamp": "2024-12-08T12:34:56.789Z"
}
```

### 5. Получение истории

### `GET /getStocks`

#### Описание:

Этот эндпоинт позволяет получить информацию о запасах товаров по различным фильтрам.
Он возвращает список товаров с данными о количестве на складе и количестве в заказах.

#### Параметры запроса (Query Parameters):

- `plu` (строка, необязательный): Уникальный идентификатор продукта (PLU).
- `shop_id` (число, необязательный): Идентификатор магазина.
- `quantity_on_shelf_min` (число, необязательный): Минимальное количество товара на складе.
- `quantity_on_shelf_max` (число, необязательный): Максимальное количество товара на складе.
- `quantity_in_order_min` (число, необязательный): Минимальное количество товара в заказах.
- `quantity_in_order_max` (число, необязательный): Максимальное количество товара в заказах.

#### Пример запроса:

```http
GET /getStocks?plu=12345&shop_id=1&quantity_on_shelf_min=10&quantity_in_order_max=50
```

#### Ответ:

Ответ содержит массив объектов, каждый из которых представляет товар в складе и его данные. Пример успешного ответа:

```json
[
  {
    "id": 1,
    "quantity_on_shelf": 15,
    "quantity_in_order": 30,
    "plu": "aa-123456",
    "product_name": "Product Name",
    "shop_id": 1,
    "shop_name": "Shop Name"
  },
  {
    "id": 2,
    "quantity_on_shelf": 20,
    "quantity_in_order": 25,
    "plu": "aa-123457",
    "product_name": "Product Name",
    "shop_id": 1,
    "shop_name": "Shop Name"
  }
]
```

#### Примечания:

- Все параметры являются необязательными, и можно комбинировать несколько фильтров для более точного поиска.
- Если параметры фильтрации не переданы, запрос вернет все доступные товары.
- Ответ может включать несколько записей для одинаковых товаров, если они находятся в разных магазинах или имеют разные данные о количестве на складе и в заказах.
